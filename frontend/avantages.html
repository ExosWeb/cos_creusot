<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prestations - COS Creusot</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/category.css">
    <link rel="stylesheet" href="css/search.css">
    <link rel="stylesheet" href="css/article-modal.css">
    <link rel="stylesheet" href="css/animations-optimized.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">üèõÔ∏è</div>
                    <div class="logo-text">
                        <h1>COS Creusot</h1>
                        <span>Comit√© des ≈íuvres Sociales</span>
                    </div>
                </div>
                
                <nav class="main-nav" id="mainNav">
                    <ul>
                        <li><a href="/">Accueil</a></li>
                        <li><a href="/avantages" class="active">Prestations</a></li>
                        <li><a href="/voyages">Voyages</a></li>
                        <li><a href="/retraites">Retraites</a></li>
                        <li><a href="/evenements">√âv√©nements</a></li>
                        <li><a href="/calendrier">Calendrier</a></li>
                        <li><a href="/contact">Contact</a></li>
                    </ul>
                </nav>

                <div class="auth-section" id="authSection">
                    <div class="auth-buttons" id="authButtons">
                        <a href="/connexion" class="btn btn-outline">Connexion</a>
                        <a href="/inscription" class="btn btn-primary">Inscription</a>
                    </div>
                    
                    <div class="user-menu" id="userMenu" style="display: none;">
                        <div class="user-info">
                            <span id="userName"></span>
                            <div class="user-dropdown">
                                <button class="btn-admin" id="adminBtn" style="display: none;">
                                    <a href="/admin">Administration</a>
                                </button>
                                <button class="btn-logout" id="logoutBtn">D√©connexion</button>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
        </div>
    </header>

    <!-- Page Header -->
    <section class="page-header">
        <div class="container">
            <div class="page-header-content">
                <div class="page-icon">üéÅ</div>
                <h1>Prestations</h1>
                <p>D√©couvrez toutes les prestations exclusives r√©serv√©es aux membres du COS Creusot</p>
            </div>
        </div>
    </section>

    <!-- Member Access Notice -->
    <section class="member-notice" id="memberNotice">
        <div class="container">
            <div class="notice-card">
                <div class="notice-icon">üîí</div>
                <div class="notice-content">
                    <h3>Acc√®s r√©serv√© aux membres</h3>
                    <p>Pour acc√©der au d√©tail de toutes nos prestations, vous devez √™tre connect√© et votre compte doit √™tre approuv√©.</p>
                    <div class="notice-actions">
                        <a href="/inscription" class="btn btn-primary">S'inscrire</a>
                        <a href="/connexion" class="btn btn-outline">Se connecter</a>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Articles Section -->
    <section class="articles-section">
        <div class="container">
            <div class="articles-grid" id="articlesGrid">
                <div class="loading">Chargement des avantages...</div>
            </div>
            
            <div class="no-articles" id="noArticles" style="display: none;">
                <div class="no-articles-content">
                    <div class="no-articles-icon">üìÑ</div>
                    <h3>Aucun avantage disponible</h3>
                    <p>Il n'y a actuellement aucun avantage publi√© dans cette cat√©gorie.</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>COS Creusot</h3>
                    <p>Comit√© des ≈íuvres Sociales<br>de la ville du Creusot</p>
                </div>
                
                <div class="footer-section">
                    <h4>Liens Rapides</h4>
                    <ul>
                        <li><a href="/avantages">Avantages</a></li>
                        <li><a href="/voyages">Voyages</a></li>
                        <li><a href="/retraites">Retraites</a></li>
                        <li><a href="/evenements">√âv√©nements</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4>Contact</h4>
                    <p>üìß contact@cos-creusot.fr</p>
                    <p>üìû 03 85 XX XX XX</p>
                    <p>üìç Le Creusot, France</p>
                </div>
                
                <div class="footer-section">
                    <h4>Suivez-nous</h4>
                    <div class="social-links">
                        <a href="#" class="social-link">Facebook</a>
                        <a href="#" class="social-link">Twitter</a>
                        <a href="#" class="social-link">LinkedIn</a>
                    </div>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2024 COS Creusot. Tous droits r√©serv√©s.</p>
            </div>
        </div>
    </footer>

    <script src="js/debug.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/categories.js"></script>
    <script src="js/article-modal.js"></script>
    <script src="js/search.js"></script>
    <script>
        // Configuration simplifi√©e pour prestations
        window.categoryConfig = {
            category: 'prestations', // Toujours prestations (canonique)
            title: 'Prestations',
            icon: 'üéÅ'
        };
        
        // Load articles when page is ready
        document.addEventListener('DOMContentLoaded', async function() {
            // Attendre que authManager soit initialis√©
            await new Promise(resolve => {
                if (window.authManager) {
                    resolve();
                } else {
                    setTimeout(resolve, 100);
                }
            });
            
            await checkAuthAndLoadArticles();
        });
        
        async function checkAuthAndLoadArticles() {
            const articlesGrid = document.getElementById('articlesGrid');
            const noArticles = document.getElementById('noArticles');
            const memberNotice = document.getElementById('memberNotice');
            const articlesSection = document.querySelector('.articles-section');
            
            if (!articlesGrid) return;
            
            try {
                // V√©rifier l'authentification
                const isAuthenticated = await window.authManager.verifyAuth();
                const userInfo = window.authManager.getCurrentUser();
                
                dlog('üîê Auth check - Authenticated:', isAuthenticated, 'User:', userInfo);
                
                // Si pas connect√© ou pas membre -> Afficher seulement le message d'acc√®s restreint
                if (!isAuthenticated || !userInfo || !['admin', 'member', 'retraite'].includes(userInfo.role)) {
                    dlog('‚ùå Access denied - showing member notice only');
                    
                    // Afficher le message d'acc√®s restreint
                    if (memberNotice) memberNotice.style.display = 'block';
                    
                    // Cacher la section articles
                    if (articlesSection) articlesSection.style.display = 'none';
                    
                    return;
                }
                
                // Si connect√© et membre -> Cacher le message et charger les articles
                dlog('‚úÖ Access granted - loading articles');
                
                // Cacher le message d'acc√®s restreint
                if (memberNotice) memberNotice.style.display = 'none';
                
                // Afficher la section articles
                if (articlesSection) articlesSection.style.display = 'block';
                
                // Charger les articles
                articlesGrid.innerHTML = '<div class="loading">Chargement des prestations...</div>';
                
                const articles = await window.CategoriesUtils.fetchCategoryArticles('prestations');
                
                if (articles.length === 0) {
                    articlesGrid.innerHTML = '<div class="loading" style="display: none;"></div>';
                    if (noArticles) noArticles.style.display = 'block';
                    return;
                }
                
                articlesGrid.style.display = 'grid';
                if (noArticles) noArticles.style.display = 'none';
                
                // Create article cards
                articlesGrid.innerHTML = articles.map(article => `
                    <article class="article-card ${article.featured ? 'featured' : ''}" data-article-id="${article.id}">
                        <div class="article-image">
                            ${article.image_url ? 
                                `<img src="${article.image_url}" alt="${article.title}" loading="lazy">` :
                                '<div class="article-placeholder">üéÅ</div>'
                            }
                        </div>
                        <div class="article-content">
                            <div class="article-meta">
                                <span class="article-category prestations">Prestations</span>
                                <span class="article-date">${new Date(article.created_at).toLocaleDateString('fr-FR')}</span>
                            </div>
                            <h3 class="article-title">${article.title}</h3>
                            <p class="article-excerpt">${article.excerpt || article.content.substring(0, 150) + '...'}</p>
                            <div class="article-actions">
                                <button onclick="openArticle(${article.id})" class="btn btn-primary">Lire plus</button>
                            </div>
                        </div>
                    </article>
                `).join('');
                
            } catch (error) {
                derror('üí• Erreur chargement prestations:', error);
                
                // En cas d'erreur, afficher le message d'acc√®s restreint par s√©curit√©
                if (memberNotice) memberNotice.style.display = 'block';
                if (articlesSection) articlesSection.style.display = 'none';
            }
        }
    </script>
</body>
</html>